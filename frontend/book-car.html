<!DOCTYPE html>
<html lang="en">
<head>
  <title>Book a Car | Sampada Tours & Travels</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Book affordable car rentals for local and outstation trips">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<header class="main-header">
  <div class="logo">
    <a href="index.html">Sampada Tours & Travels</a>
  </div>
  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="tours.html">Tours</a>
    <a href="car-rentals.html" class="active">Car Rentals</a>
    <a href="contact.html">Contact</a>
  </nav>
  <div class="auth-links" id="authLinks">
    <!-- Auth UI injected by auth.js -->
  </div>
</header>

<main class="container section">
  <h1>Book a Car</h1>

  <!-- Alert Box -->
  <div id="alertBox" class="alert-box" role="alert" style="display: none;"></div>

  <form id="carBookingForm" class="booking-form" novalidate>

    <fieldset>
      <legend>Trip & Vehicle Details</legend>
      <p class="form-instruction">Calculate your estimated cost by selecting your trip details.</p>

      <div class="form-group">
        <label for="vehicle">Vehicle Type</label>
        <select id="vehicle" required aria-describedby="vehicleError">
          <option value="">Select Vehicle</option>
          <option value="Sedan" data-local="12" data-outstation="13" data-driver="300">Sedan (Swift Dzire)</option>
          <option value="SUV" data-local="15" data-outstation="16" data-driver="350">SUV (Innova)</option>
          <option value="Tempo" data-local="20" data-outstation="22" data-driver="400">Tempo Traveller</option>
        </select>
        <span id="vehicleError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="tripType">Trip Type</label>
        <select id="tripType" required aria-describedby="tripTypeError">
          <option value="">Select Trip Type</option>
          <option value="Local">Local (Within city)</option>
          <option value="Outstation">Outstation (Outside city)</option>
        </select>
        <span id="tripTypeError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="kms">Distance (KM)</label>
        <input type="number" id="kms" min="1" required aria-describedby="kmsError">
        <span id="kmsError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="days">Number of Days</label>
        <input type="number" id="days" min="1" value="1" required aria-describedby="daysError">
        <span id="daysError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <input type="checkbox" id="noDriver">
        <label for="noDriver">No Driver Required (Self-Drive)</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Cost Summary</legend>
      <div class="form-group">
        <label for="pricePerKm">Price per KM (₹)</label>
        <input type="number" id="pricePerKm" value="0" readonly>
      </div>

      <div class="form-group">
        <label for="driverPerDay">Driver Allowance / Day (₹)</label>
        <input type="number" id="driverPerDay" value="0" readonly>
      </div>

      <div class="form-group">
        <label for="driverTotal">Total Driver Allowance (₹)</label>
        <input type="number" id="driverTotal" value="0" readonly>
      </div>

      <div class="form-group total-amount-group">
        <label for="totalAmount">Total Estimated Amount (₹)</label>
        <input type="number" id="totalAmount" value="0" readonly>
      </div>
    </fieldset>

    <fieldset>
      <legend>Your Contact Information</legend>

      <div class="form-group">
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" required>
        <span id="fullNameError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number *</label>
        <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" required>
        <span id="phoneError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="email">Email (Optional)</label>
        <input type="email" id="email">
        <span id="emailError" class="error-message" style="display: none;"></span>
      </div>

      <div class="form-group">
        <label for="startDate">Travel Start Date *</label>
        <input type="date" id="startDate" required>
        <span id="startDateError" class="error-message" style="display: none;"></span>
      </div>
    </fieldset>

    <button type="submit" class="btn-submit" id="submitBtn">
      <i class="fas fa-check-circle"></i> Confirm Booking
    </button>
  </form>
</main>

<footer class="main-footer">
  <div class="footer-content">
    <p>Sampada Tours & Travels</p>
    <p class="address"><i class="fas fa-map-marker-alt"></i> Kirana Bazar Road, Mominpura, Kalaburagi, Karnataka</p>
    <p class="copyright">© 2025 Sampada Tours & Travels</p>
  </div>
</footer>

<!-- Central Auth Script -->
<script src="js/auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  AUTH.updateAuthUI();

  // Set minimum date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("startDate").setAttribute("min", today);

  // Prefill name if logged in
  const user = AUTH.getCurrentUser();
  if (user && user.username) {
    document.getElementById("fullName").value = user.username;
  }
});

/* ===========================
   UTILITY FUNCTIONS
=========================== */
function showAlert(message, type = 'error') {
  const alertBox = document.getElementById('alertBox');
  alertBox.textContent = message;
  alertBox.className = `alert-box ${type}`;
  alertBox.style.display = 'block';
  setTimeout(() => alertBox.style.display = 'none', 5000);
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validatePhone(phone) {
  return /^[0-9]{10}$/.test(phone);
}

/* ===========================
   PRICE CALCULATION
=========================== */
function calculatePrice() {
  const vehicleSelect = document.getElementById("vehicle");
  const tripType = document.getElementById("tripType").value;
  const kms = parseFloat(document.getElementById("kms").value) || 0;
  const days = parseInt(document.getElementById("days").value) || 1;
  const noDriver = document.getElementById("noDriver").checked;

  const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
  if (!selectedOption || !tripType) return;

  const localRate = parseFloat(selectedOption.dataset.local) || 0;
  const outstationRate = parseFloat(selectedOption.dataset.outstation) || 0;
  const driverAllowancePerDay = parseFloat(selectedOption.dataset.driver) || 0;

  const pricePerKm = tripType === "Local" ? localRate : outstationRate;
  const driverPerDay = noDriver ? 0 : driverAllowancePerDay;
  const driverTotal = driverPerDay * days;
  const totalAmount = (kms * pricePerKm) + driverTotal;

  document.getElementById("pricePerKm").value = pricePerKm;
  document.getElementById("driverPerDay").value = driverPerDay;
  document.getElementById("driverTotal").value = driverTotal;
  document.getElementById("totalAmount").value = totalAmount;
}

["vehicle", "tripType", "kms", "days", "noDriver"].forEach(id => {
  document.getElementById(id).addEventListener("change", calculatePrice);
});

/* ===========================
   FORM SUBMISSION
=========================== */
document.getElementById("carBookingForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const bookingData = {
    vehicle: document.getElementById("vehicle").value,
    tripType: document.getElementById("tripType").value,
    kms: parseFloat(document.getElementById("kms").value),
    days: parseInt(document.getElementById("days").value),
    noDriver: document.getElementById("noDriver").checked,
    fullName: document.getElementById("fullName").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim() || null,
    startDate: document.getElementById("startDate").value,
    totalAmount: parseFloat(document.getElementById("totalAmount").value)
  };

  try {
    const result = await AUTH.apiRequest('/book-car', {
      method: "POST",
      body: JSON.stringify(bookingData)
    });

    showAlert(result.message || 'Car booking confirmed!', 'success');
    setTimeout(() => window.location.href = "index.html", 2000);

  } catch (err) {
    console.error(err);
    showAlert(err.message || 'Booking failed. Please try again.');
  }
});
</script>

</body>
</html>
