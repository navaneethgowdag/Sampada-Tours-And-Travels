<!DOCTYPE html>
<html lang="en">
<head>
  <title>Book a Car | Sampada Tours & Travels</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Book affordable car rentals for local and outstation trips">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    .seat-badge {
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(37,99,235,0.25);
      display: none;
      animation: fadeInSeat 0.3s ease-in;
    }

    @keyframes fadeInSeat {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<header class="main-header">
  <div class="logo">
    <a href="index.html">Sampada Tours & Travels</a>
  </div>
  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="tours.html">Tours</a>
    <a href="car-rentals.html" class="active">Car Rentals</a>
    <a href="booking-dashboard.html"  >My Bookings</a>
    <a href="feedback.html">Feedback</a>
  </nav>
  <div class="auth-links" id="authLinks"></div>
</header>

<main class="container section">
  <h1>Book a Car</h1>

  <!-- Alert Box -->
  <div id="alertBox" class="alert-box" role="alert" style="display: none;"></div>

  <form id="carBookingForm" class="booking-form" novalidate>

    <fieldset>
      <legend>Trip & Vehicle Details</legend>
      <p class="form-instruction">Calculate your estimated cost by selecting your trip details.</p>

      <div class="form-group">
        <label for="vehicle">Vehicle Type</label>
        <select id="vehicle" required>
          <option value="">Select Vehicle</option>
          <option value="Sedan" data-local="12" data-outstation="13" data-driver="300" data-seats="4">Sedan (Swift Dzire)</option>
          <option value="SUV" data-local="15" data-outstation="16" data-driver="350" data-seats="6">SUV (Innova)</option>
          <option value="Tempo" data-local="20" data-outstation="22" data-driver="400" data-seats="12">Tempo Traveller</option>
        </select>

        <!-- SEAT BADGE -->
        <span id="seatBadge" class="seat-badge">Max seats: 0</span>
      </div>

      <div class="form-group">
        <label for="tripType">Trip Type</label>
        <select id="tripType" required>
          <option value="">Select Trip Type</option>
          <option value="Local">Local (Within city)</option>
          <option value="Outstation">Outstation (Outside city)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="kms">Distance (KM)</label>
        <input type="number" id="kms" min="1" required>
      </div>

      <div class="form-group">
        <label for="days">Number of Days</label>
        <input type="number" id="days" min="1" value="1" required>
      </div>

      <div class="form-group">
        <input type="checkbox" id="noDriver">
        <label for="noDriver">No Driver Required (Self-Drive)</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Cost Summary</legend>
      <div class="form-group">
        <label for="pricePerKm">Price per KM (‚Çπ)</label>
        <input type="number" id="pricePerKm" value="0" readonly>
      </div>

      <div class="form-group">
        <label for="driverPerDay">Driver Allowance / Day (‚Çπ)</label>
        <input type="number" id="driverPerDay" value="0" readonly>
      </div>

      <div class="form-group">
        <label for="driverTotal">Total Driver Allowance (‚Çπ)</label>
        <input type="number" id="driverTotal" value="0" readonly>
      </div>

      <div class="form-group total-amount-group">
        <label for="totalAmount">Total Estimated Amount (‚Çπ)</label>
        <input type="number" id="totalAmount" value="0" readonly>
      </div>
    </fieldset>

    <fieldset>
      <legend>Your Contact Information</legend>

      <div class="form-group">
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number *</label>
        <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" required>
      </div>

      <div class="form-group">
        <label for="email">Email (Optional)</label>
        <input type="email" id="email">
      </div>

      <div class="form-group">
        <label for="startDate">Travel Start Date *</label>
        <input type="date" id="startDate" required>
      </div>
    </fieldset>

    <button type="submit" class="btn-submit" id="submitBtn">
      <i class="fas fa-check-circle"></i> Confirm Booking
    </button>
  </form>
</main>

<footer class="main-footer" role="contentinfo">
  <div class="footer-content">

    <!-- 1) Brand -->
    <p class="footer-brand">Sampada Tours & Travels</p>

    <!-- 2) Contact (primary action) -->
    <p class="footer-contact">
      <i class="fas fa-phone"></i> +91 83106 34274 &nbsp; | &nbsp;
      <i class="fas fa-envelope"></i> sampadatravels777@gmail.com
    </p>

    <!-- 3) Location (map link) -->
    <p class="address">
      <a 
        href="https://www.google.com/maps/search/?api=1&query=Kirana+Bazar+Road,+Mominpura,+Kalaburagi,+Karnataka"
        target="_blank" 
        rel="noopener noreferrer"
        class="map-link"
      >
        <i class="fas fa-map-marker-alt"></i>
        Kirana Bazar Road, Mominpura, Kalaburagi, Karnataka
      </a>
    </p>

    <!-- 4) Legal -->
    <p class="copyright">
      ¬© <span id="year"></span> Sampada Tours & Travels ¬∑ All rights reserved
    </p>

    <!-- 5) Developer Credit -->
    <p class="dev-credit">
      Developed by <strong>Navaneeth Gowda G</strong>
      &
      <strong>Abhishek Kumar Kolli</strong>
    </p>

  </div>
</footer>

<script src="auth.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    AUTH.updateAuthUI();

    const today = new Date().toISOString().split('T')[0];
    document.getElementById("startDate").setAttribute("min", today);

    const user = AUTH.getCurrentUser();
    if (user && user.username) {
      document.getElementById("fullName").value = user.username;
    }

    // ‚úÖ AUTO-FILL VEHICLE FROM URL
    const params = new URLSearchParams(window.location.search);
    const selectedVehicle = params.get("vehicle"); // Sedan / SUV / Tempo

    if (selectedVehicle) {
      const vehicleSelect = document.getElementById("vehicle");
      vehicleSelect.value = selectedVehicle;

      // Trigger calculation + seat badge update
      vehicleSelect.dispatchEvent(new Event("change"));
    }
  });


  // Cache elements (faster)
  const vehicleSelect = document.getElementById("vehicle");
  const tripTypeSelect = document.getElementById("tripType");
  const kmsInput = document.getElementById("kms");
  const daysInput = document.getElementById("days");
  const noDriverCheckbox = document.getElementById("noDriver");

  const pricePerKmInput = document.getElementById("pricePerKm");
  const driverPerDayInput = document.getElementById("driverPerDay");
  const driverTotalInput = document.getElementById("driverTotal");
  const totalAmountInput = document.getElementById("totalAmount");

  const seatBadge = document.getElementById("seatBadge");

  /* ===========================
     PRICE + SEAT BADGE
  =========================== */
  function calculatePrice() {
    const vehicleValue = vehicleSelect.value;
    const tripType = tripTypeSelect.value;
    const kms = parseFloat(kmsInput.value) || 0;
    const days = parseInt(daysInput.value) || 1;
    const noDriver = noDriverCheckbox.checked;

    // If no vehicle selected ‚Üí hide badge + reset
    if (!vehicleValue) {
      seatBadge.style.display = "none";
      pricePerKmInput.value = 0;
      driverPerDayInput.value = 0;
      driverTotalInput.value = 0;
      totalAmountInput.value = 0;
      return;
    }

    const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];

    /* üëâ SEAT BADGE */
    const seats = selectedOption.dataset.seats;
    if (seats) {
      seatBadge.textContent = `Max seats: ${seats}`;
      seatBadge.style.display = "inline-block";
    } else {
      seatBadge.style.display = "none";
    }

    // If trip type not selected, don‚Äôt calculate yet
    if (!tripType) {
      totalAmountInput.value = 0;
      return;
    }

    const localRate = parseFloat(selectedOption.dataset.local) || 0;
    const outstationRate = parseFloat(selectedOption.dataset.outstation) || 0;
    const driverAllowancePerDay = parseFloat(selectedOption.dataset.driver) || 0;

    const pricePerKm = tripType === "Local" ? localRate : outstationRate;
    const driverPerDay = noDriver ? 0 : driverAllowancePerDay;
    const driverTotal = driverPerDay * days;
    const totalAmount = (kms * pricePerKm) + driverTotal;

    pricePerKmInput.value = pricePerKm;
    driverPerDayInput.value = driverPerDay;
    driverTotalInput.value = driverTotal;
    totalAmountInput.value = Math.round(totalAmount);
  }

  // üîÅ FAST, REAL-TIME UPDATES
  ["change", "input"].forEach(evt => {
    vehicleSelect.addEventListener(evt, calculatePrice);
    tripTypeSelect.addEventListener(evt, calculatePrice);
    kmsInput.addEventListener(evt, calculatePrice);
    daysInput.addEventListener(evt, calculatePrice);
    noDriverCheckbox.addEventListener(evt, calculatePrice);
  });

  /* ===========================
     FORM SUBMISSION
  =========================== */
  document.getElementById("carBookingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const bookingData = {
      vehicle: vehicleSelect.value,
      tripType: tripTypeSelect.value,
      kms: parseFloat(kmsInput.value),
      days: parseInt(daysInput.value),
      noDriver: noDriverCheckbox.checked,
      fullName: document.getElementById("fullName").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      email: document.getElementById("email").value.trim() || null,
      startDate: document.getElementById("startDate").value,
      totalAmount: parseFloat(totalAmountInput.value)
    };

    try {
      const result = await AUTH.apiRequest('/book-car', {
        method: "POST",
        body: JSON.stringify(bookingData)
      });

      alert("‚úÖ Car booking confirmed! We will contact you shortly.");
      setTimeout(() => window.location.href = "index.html", 2000);

    } catch (err) {
      console.error(err);

      if (err.message && err.message.includes("Failed to fetch")) {
        alert("‚ö†Ô∏è You are not logged in or your session has expired.\n\nPlease login to continue booking.");
        const redirectUrl = "car-booking.html" + location.search;
        window.location.href = "login.html?redirect=" + encodeURIComponent(redirectUrl);
        return;
      }

      alert(err.message || 'Booking failed. Please try again.');
    }
  });

</script>

</body>
</html>
