<!DOCTYPE html>
<html lang="en">
<head>
  <title>Book Package | Sampada Tours & Travels</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<header class="main-header">
  <div class="logo"><a href="index.html">Sampada Tours & Travels</a></div>
  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="tours.html" class="active">Tours</a>
    <a href="car-rentals.html">Car Rentals</a>
    <a href="booking-dashboard.html" >My Bookings</a>
    <a href="feedback.html">Feedback</a>
  </nav>
  <div class="auth-links" id="authLinks">
    <!-- Auth UI injected by auth.js -->
  </div>
</header>

<main class="container section">
  <h1>Book Your Tour Package</h1>
  <div id="alertBox" class="alert-box" style="display:none;"></div>

  <form id="bookingForm" class="booking-form">
    <fieldset>
      <legend>Choose Your Package</legend>
      <div class="form-group">
        <label for="tourSelect">Tour Package *</label>
        <select id="tourSelect" required>
          <option value="">Select Tour Package</option>
          <option value="Hampi" data-price="3500" data-days="2">Hampi Tour - ‚Çπ3,500</option>
          <option value="Bidar" data-price="2500" data-days="1">Bidar Tour - ‚Çπ2,500</option>
          <option value="Vijayapura" data-price="4500" data-days="2">Vijayapura Tour - ‚Çπ4,500</option>
          <option value="Custom">Custom Package</option>
        </select>
      </div>
      <div class="form-group">
        <label for="pricePerPerson">Price per Person (‚Çπ)</label>
        <input type="number" id="pricePerPerson" value="0" readonly>
      </div>
      <div class="form-group">
        <label for="peopleCount">Number of People *</label>
        <input type="number" id="peopleCount" min="1" value="1" required>
      </div>
    </fieldset>

    <fieldset id="pickupLocationSection" style="display:none;">
      <legend>Pickup Location</legend>
      <div class="form-group">
        <p style="margin: 0 0 10px 0; color: #333;">
          <i class="fas fa-map-pin" style="color: #ff6b6b; margin-right: 8px;"></i>
          <strong>Pickup Point:</strong> Kalaburagi
          <a href="" id="pickupMapLink" target="_blank" style="margin-left: 10px; color: #007bff; text-decoration: none;">
            <i class="fas fa-map-marked-alt"></i> View on Map
          </a>
        </p>
      </div>
    </fieldset>

    <fieldset id="placesCoveredSection" style="display:none;">
      <legend>Places Covered in this Package</legend>
      <div class="form-group">
        <ul id="placesList" style="list-style: none; padding-left: 0; line-height: 1.8;">
          <!-- Places will be dynamically inserted here -->
        </ul>
      </div>
    </fieldset>

    <fieldset id="customFields" style="display:none;">
      <legend>Custom Tour Details</legend>
      <div class="form-group">
        <label for="fromPlace">From Location</label>
        <input type="text" id="fromPlace" placeholder="e.g., Kalaburagi">
      </div>
      <div class="form-group">
        <label for="toPlace">To Location</label>
        <input type="text" id="toPlace" placeholder="e.g., Goa">
      </div>
      <div class="form-group">
        <label for="days">Number of Days</label>
        <input type="number" id="days" min="1" placeholder="e.g., 3">
      </div>
      <div class="form-group">
        <label for="kms">Approx Distance (KM)</label>
        <input type="number" id="kms" min="1" placeholder="e.g., 500">
      </div>
    </fieldset>

    <fieldset>
      <legend>Total Cost</legend>
      <div class="form-group total-amount-group">
        <label for="totalAmount">Total Amount (‚Çπ)</label>
        <input type="number" id="totalAmount" value="0" readonly style="font-size:1.2em;font-weight:bold;">
      </div>
    </fieldset>

    <fieldset>
      <legend>Contact Information</legend>
      <div class="form-group">
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone *</label>
        <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email">
      </div>
      <div class="form-group">
        <label for="travelDate">Travel Date *</label>
        <input type="date" id="travelDate" required>
      </div>
    </fieldset>

    <button type="submit" class="btn-submit" id="submitBtn">
      <i class="fas fa-paper-plane"></i> Confirm Booking
    </button>
  </form>
</main>

<footer class="main-footer" role="contentinfo">
  <div class="footer-content">

    <!-- 1) Brand -->
    <p class="footer-brand">Sampada Tours & Travels</p>

    <!-- 2) Contact (primary action) -->
    <p class="footer-contact">
      <i class="fas fa-phone"></i> +91 83106 34274 &nbsp; | &nbsp;
      <i class="fas fa-envelope"></i> sampadatravels777@gmail.com
    </p>

    <!-- 3) Location (map link) -->
    <p class="address">
      <a 
        href="https://www.google.com/maps/place/Ashok+Chowk,+Gunj+Rd,+near+Ashok+Chowk,+Mominpura,+Kalaburagi,+Karnataka+585101/@17.3464983,76.8383556,17z/data=!3m1!4b1!4m6!3m5!1s0x3bc8c742c450220d:0x93fb206cca6f7915!8m2!3d17.3464983!4d76.8383556!16s%2Fg%2F11gh9q8016!17m2!4m1!1e3!18m1!1e1?entry=ttu&g_ep=EgoyMDI2MDIwMy4wIKXMDSoASAFQAw%3D%3D"
        target="_blank" 
        rel="noopener noreferrer"
        class="map-link"
      >
        <i class="fas fa-map-marker-alt"></i>
        Kirana Bazar Road, Mominpura, Kalaburagi, Karnataka
      </a>
    </p>

    <!-- 4) Legal -->
    <p class="copyright">
      ¬© <span id="year"></span> Sampada Tours & Travels ¬∑ All rights reserved
    </p>

    <!-- 5) Developer Credit -->
    <p class="dev-credit">
      Developed by <strong>Navaneeth Gowda G</strong>
      &
      <strong>Abhishek Kumar Kolli</strong>
    </p>

  </div>
</footer>

<!-- Central Auth Script -->
<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // PLACES DATA
    const packagePlaces = {
        'Hampi': [
            'Virupaksha Temple',
            'Hampi Bazaar',
            'Lotus Mahal',
            'Vittala Temple',
            'Stone Chariot',
            'Matanga Hill'
        ],
        'Bidar': [
            'Bidar Fort',
            'Chaubara (Watch Tower)',
            'Mahmud Gawan Madrasa',
            'Bahmani Tombs',
            'Solah Khamba Mosque'
        ],
        'Vijayapura': [
            'Gol Gumbaz',
            'Ibrahim Rauza',
            'Malik-e-Maidan (Cannon)',
            'Jama Masjid',
            'Bara Kaman'
        ]
    };

    // PICKUP LOCATION DATA
    const pickupMapLinks = {
        'Hampi': 'https://www.google.com/maps/place/Ashok+Chowk,+Gunj+Rd,+near+Ashok+Chowk,+Mominpura,+Kalaburagi,+Karnataka+585101/@17.3464983,76.8383556,17z/data=!3m1!4b1!4m6!3m5!1s0x3bc8c742c450220d:0x93fb206cca6f7915!8m2!3d17.3464983!4d76.8383556!16s%2Fg%2F11gh9q8016!17m2!4m1!1e3!18m1!1e1?entry=ttu&g_ep=EgoyMDI2MDIwMy4wIKXMDSoASAFQAw%3D%3D', 
        'Bidar': 'https://www.google.com/maps/place/Ashok+Chowk,+Gunj+Rd,+near+Ashok+Chowk,+Mominpura,+Kalaburagi,+Karnataka+585101/@17.3464983,76.8383556,17z/data=!3m1!4b1!4m6!3m5!1s0x3bc8c742c450220d:0x93fb206cca6f7915!8m2!3d17.3464983!4d76.8383556!16s%2Fg%2F11gh9q8016!17m2!4m1!1e3!18m1!1e1?entry=ttu&g_ep=EgoyMDI2MDIwMy4wIKXMDSoASAFQAw%3D%3D',  
        'Vijayapura': 'https://www.google.com/maps/place/Ashok+Chowk,+Gunj+Rd,+near+Ashok+Chowk,+Mominpura,+Kalaburagi,+Karnataka+585101/@17.3464983,76.8383556,17z/data=!3m1!4b1!4m6!3m5!1s0x3bc8c742c450220d:0x93fb206cca6f7915!8m2!3d17.3464983!4d76.8383556!16s%2Fg%2F11gh9q8016!17m2!4m1!1e3!18m1!1e1?entry=ttu&g_ep=EgoyMDI2MDIwMy4wIKXMDSoASAFQAw%3D%3D' 
    };

    // 1. üîê AUTHENTICATION CHECK
    const user = AUTH.getCurrentUser();
    if (!user) {
        alert("Please login to book a package.");
        const redirectUrl = "book-package.html" + location.search;
        window.location.href = `login.html?redirect=${encodeURIComponent(redirectUrl)}`;
        return;
    }

    AUTH.updateAuthUI();

    // 2. DOM ELEMENTS
    const form = document.getElementById('bookingForm');
    const tourSelect = document.getElementById('tourSelect');
    const customFields = document.getElementById('customFields');
    const alertBox = document.getElementById('alertBox');
    const priceInput = document.getElementById('pricePerPerson');
    const totalInput = document.getElementById('totalAmount');
    const submitBtn = document.getElementById('submitBtn');

    // 3. PAGE INITIALIZATION
    // Set min date to today
    document.getElementById('travelDate').min = new Date().toISOString().split('T')[0];

    // Prefill username
    if (user.username) {
        document.getElementById('fullName').value = user.username;
    }

    // Auto-fill package from URL
    const params = new URLSearchParams(window.location.search);
    const urlPkg = params.get('package');
    if (urlPkg) {
        tourSelect.value = urlPkg;
        updateFormUI(); // Trigger UI change
    }

    // 4. CALCULATION LOGIC
    function calculateTotal() {

      const isCustom = tourSelect.value === 'Custom';
      const people = parseInt(document.getElementById('peopleCount').value) || 1;

      let total = 0;

      if (isCustom) {
        const kmInput = document.getElementById('kms').value;
        const daysInput = document.getElementById('days').value;

        const km = parseFloat(kmInput);
        const days = parseInt(daysInput);

        // Validate custom fields
        if (!km || km <= 0 || !days || days <= 0) {
            totalInput.value = 0;
            return;
        }

        const ratePerKm = 12; // Custom package rate
        total = km * ratePerKm * days * people;

    } else {
        const price = parseFloat(priceInput.value) || 0;
        total = price * people;
    }

      totalInput.value = Math.round(total);
    }


    function updateFormUI() {
        const isCustom = tourSelect.value === 'Custom';
        customFields.style.display = isCustom ? 'block' : 'none';

        // Update price per person from data attributes
        const selectedOption = tourSelect.options[tourSelect.selectedIndex];
        priceInput.value = selectedOption.dataset.price || 0;

        calculateTotal();

        // Update pickup location section (ONLY for predefined packages, NOT for Custom)
        const pickupLocationSection = document.getElementById('pickupLocationSection');
        const pickupMapLink = document.getElementById('pickupMapLink');

        if (tourSelect.value && tourSelect.value !== 'Custom' && pickupMapLinks[tourSelect.value]) {
            pickupMapLink.href = pickupMapLinks[tourSelect.value];
            pickupLocationSection.style.display = 'block';
        } else {
            pickupLocationSection.style.display = 'none';
        }

        // Update places covered section
        const placesCoveredSection = document.getElementById('placesCoveredSection');
        const placesList = document.getElementById('placesList');
        
        if (tourSelect.value && tourSelect.value !== 'Custom' && packagePlaces[tourSelect.value]) {
            const places = packagePlaces[tourSelect.value];
            placesList.innerHTML = places.map(place => 
                `<li><i class="fas fa-map-marker-alt" style="color: #ff6b6b; margin-right: 8px;"></i>${place}</li>`
            ).join('');
            placesCoveredSection.style.display = 'block';
        } else if (tourSelect.value === 'Custom') {
            placesList.innerHTML = '<li style="color: #666; font-style: italic;"><i class="fas fa-info-circle" style="margin-right: 8px;"></i>Places will be planned as per your request.</li>';
            placesCoveredSection.style.display = 'block';
        } else {
            placesCoveredSection.style.display = 'none';
        }
    }

    // 5. EVENT LISTENERS
    tourSelect.addEventListener('change', updateFormUI);

    // Listen to all relevant inputs for real-time calculation
    ['peopleCount', 'kms', 'days', 'pricePerPerson'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calculateTotal);
    });

    // 6. FORM SUBMISSION
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Final Auth check
        if (!AUTH.getCurrentUser()) {
            window.location.reload();
            return;
        }

        // UI Loading State
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        alertBox.style.display = 'none';

        const isCustom = tourSelect.value === 'Custom';
        const selectedOption = tourSelect.options[tourSelect.selectedIndex];

        const payload = {
            package_name: tourSelect.value,
            price_per_person: parseFloat(priceInput.value),
            people_count: parseInt(document.getElementById('peopleCount').value),
            from_place: isCustom ? document.getElementById('fromPlace').value : "Kalaburagi",
            to_place: isCustom ? document.getElementById('toPlace').value : tourSelect.value,
            days: isCustom 
                ? parseInt(document.getElementById('days').value) 
                : parseInt(selectedOption.dataset.days),
            kms: isCustom ? parseFloat(document.getElementById('kms').value) : null,
            total_amount: parseFloat(totalInput.value),
            travel_date: document.getElementById('travelDate').value,
            full_name: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value || null
        };

        try {
            await AUTH.apiRequest('/bookings/package', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            alert("‚úÖ Booking Successful! Our team will contact you shortly.");
            window.location.href = "index.html";

        } catch (err) {
            console.error(err);

            // üö® Handle "Failed to fetch" (CORS / Network / Not logged in)
            if (err.message && err.message.includes("Failed to fetch")) {
                alert("‚ö†Ô∏è You are not logged in or your session has expired.\n\nPlease login to continue booking.");

                const redirectUrl = "book-package.html" + location.search;
                window.location.href = "login.html?redirect=" + encodeURIComponent(redirectUrl);
                return;
            }

            // Other backend errors
            alertBox.textContent = err.message || 'Booking failed. Please try again.';
            alertBox.className = 'alert-box error';
            alertBox.style.display = 'block';

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Confirm Booking';
        }
    });
});
</script>


</body>
</html>