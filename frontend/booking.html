<!DOCTYPE html>
<html lang="en">
<head>
  <title>Book Package | Sampada Tours & Travels</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<header class="main-header">
  <div class="logo"><a href="index.html">Sampada Tours & Travels</a></div>
  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="tours.html" class="active">Tours</a>
    <a href="car-rentals.html">Car Rentals</a>
    <a href="contact.html">Contact</a>
  </nav>
  <div class="auth-links" id="authLinks">
    <!-- Auth UI injected by auth.js -->
  </div>
</header>

<main class="container section">
  <h1>Book Your Tour Package</h1>
  <div id="alertBox" class="alert-box" style="display:none;"></div>

  <form id="bookingForm" class="booking-form">
    <fieldset>
      <legend>Choose Your Package</legend>
      <div class="form-group">
        <label for="tourSelect">Tour Package *</label>
        <select id="tourSelect" required>
          <option value="">Select Tour Package</option>
          <option value="Hampi" data-price="3500" data-days="2">Hampi Tour - ₹3,500</option>
          <option value="Bidar" data-price="2500" data-days="1">Bidar Tour - ₹2,500</option>
          <option value="Vijayapura" data-price="4500" data-days="2">Vijayapura Tour - ₹4,500</option>
          <option value="Custom">Custom Package</option>
        </select>
      </div>
      <div class="form-group">
        <label for="pricePerPerson">Price per Person (₹)</label>
        <input type="number" id="pricePerPerson" value="0" readonly>
      </div>
      <div class="form-group">
        <label for="peopleCount">Number of People *</label>
        <input type="number" id="peopleCount" min="1" value="1" required>
      </div>
    </fieldset>

    <fieldset id="customFields" style="display:none;">
      <legend>Custom Tour Details</legend>
      <div class="form-group">
        <label for="fromPlace">From Location</label>
        <input type="text" id="fromPlace" placeholder="e.g., Kalaburagi">
      </div>
      <div class="form-group">
        <label for="toPlace">To Location</label>
        <input type="text" id="toPlace" placeholder="e.g., Goa">
      </div>
      <div class="form-group">
        <label for="days">Number of Days</label>
        <input type="number" id="days" min="1" placeholder="e.g., 3">
      </div>
      <div class="form-group">
        <label for="kms">Approx Distance (KM)</label>
        <input type="number" id="kms" min="1" placeholder="e.g., 500">
      </div>
    </fieldset>

    <fieldset>
      <legend>Total Cost</legend>
      <div class="form-group total-amount-group">
        <label for="totalAmount">Total Amount (₹)</label>
        <input type="number" id="totalAmount" value="0" readonly style="font-size:1.2em;font-weight:bold;">
      </div>
    </fieldset>

    <fieldset>
      <legend>Contact Information</legend>
      <div class="form-group">
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone *</label>
        <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email">
      </div>
      <div class="form-group">
        <label for="travelDate">Travel Date *</label>
        <input type="date" id="travelDate" required>
      </div>
    </fieldset>

    <button type="submit" class="btn-submit" id="submitBtn">
      <i class="fas fa-paper-plane"></i> Confirm Booking
    </button>
  </form>
</main>

<footer class="main-footer">
  <div class="footer-content">
    <p>Sampada Tours & Travels</p>
    <p class="copyright">© 2025 Sampada Tours & Travels</p>
  </div>
</footer>

<!-- Central Auth Script -->
<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  AUTH.updateAuthUI();

  // Set min date
  document.getElementById('travelDate').min = new Date().toISOString().split('T')[0];

  // Auto-fill from URL
  const params = new URLSearchParams(location.search);
  if (params.get('package')) {
    tourSelect.value = params.get('package');
    tourSelect.dispatchEvent(new Event('change'));
  }

  // Prefill name if logged in
  const user = AUTH.getCurrentUser();
  if (user && user.username) {
    document.getElementById('fullName').value = user.username;
  }
});

const form = document.getElementById('bookingForm');
const tourSelect = document.getElementById('tourSelect');
const customFields = document.getElementById('customFields');
const alertBox = document.getElementById('alertBox');

// Toggle custom fields
tourSelect.addEventListener('change', e => {
  const isCustom = e.target.value === 'Custom';
  customFields.style.display = isCustom ? 'block' : 'none';
  const opt = e.target.options[e.target.selectedIndex];
  document.getElementById('pricePerPerson').value = opt.dataset.price || 0;
  calculate();
});

// Calculate total
['peopleCount', 'kms', 'days'].forEach(id => {
  document.getElementById(id)?.addEventListener('input', calculate);
});

function calculate() {
  const price = +document.getElementById('pricePerPerson').value;
  const people = +document.getElementById('peopleCount').value || 1;
  const isCustom = tourSelect.value === 'Custom';
  
  if (isCustom) {
    const km = +document.getElementById('kms').value || 0;
    const days = +document.getElementById('days').value || 0;
    document.getElementById('totalAmount').value = km > 0 && days > 0 ? km * 12 * days * people : 0;
  } else {
    document.getElementById('totalAmount').value = price * people;
  }
}

// Submit booking
form.addEventListener('submit', async e => {
  e.preventDefault();

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

  const isCustom = tourSelect.value === 'Custom';
  const data = {
    package_name: tourSelect.value,
    price_per_person: +document.getElementById('pricePerPerson').value,
    people_count: +document.getElementById('peopleCount').value,
    from_place: isCustom ? document.getElementById('fromPlace').value : null,
    to_place: isCustom ? document.getElementById('toPlace').value : null,
    days: isCustom ? +document.getElementById('days').value : +tourSelect.options[tourSelect.selectedIndex].dataset.days,
    kms: isCustom ? +document.getElementById('kms').value : null,
    total_amount: +document.getElementById('totalAmount').value,
    travel_date: document.getElementById('travelDate').value,
    full_name: document.getElementById('fullName').value,
    phone: document.getElementById('phone').value,
    email: document.getElementById('email').value || null
  };

  try {
    const result = await AUTH.apiRequest('/bookings/package', {
      method: 'POST',
      body: JSON.stringify(data)
    });

    alertBox.textContent = result.message || 'Booking confirmed!';
    alertBox.className = 'alert-box success';
    alertBox.style.display = 'block';

    setTimeout(() => location.href = 'index.html', 2000);

  } catch (err) {
    console.error(err);
    alertBox.textContent = err.message || 'Booking failed. Please try again.';
    alertBox.className = 'alert-box error';
    alertBox.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Confirm Booking';
  }
});
</script>

</body>
</html>
