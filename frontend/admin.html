<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin Dashboard | Sampada Tours & Travels</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .admin-card {
      background: #fff;
      padding: 20px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .admin-card h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .admin-table th, .admin-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .admin-table th {
      background: #f3f6ff;
      font-weight: 600;
    }

    .section-box {
      margin: 40px 0;
    }

    .status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status.pending { background: #fff3cd; color: #856404; }
    .status.confirmed { background: #d1fae5; color: #065f46; }
    .status.completed { background: #e0e7ff; color: #3730a3; }

    .empty-box {
      padding: 20px;
      background: #f9fafb;
      border: 1px dashed #ccc;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<header class="main-header">
  <div class="logo"><a href="index.html">Sampada Tours & Travels</a></div>
  <nav class="main-nav">
    <a href="admin.html" class="active">Admin</a>
  </nav>
  <div class="auth-links" id="authLinks"></div>
</header>

<main class="container section">
  <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
  <p>Manage users, bookings, and feedback.</p>

  <div id="alertBox" class="alert-box" style="display:none;"></div>

  <!-- QUICK STATS -->
  <div class="admin-grid">
    <div class="admin-card">
      <h3>Total Users</h3>
      <p id="totalUsers">0</p>
    </div>
    <div class="admin-card">
      <h3>Package Bookings</h3>
      <p id="totalPackages">0</p>
    </div>
    <div class="admin-card">
      <h3>Car Bookings</h3>
      <p id="totalCars">0</p>
    </div>
    <div class="admin-card">
      <h3>Feedback Messages</h3>
      <p id="totalFeedback">0</p>
    </div>
  </div>

  <!-- USERS -->
  <div class="section-box">
    <h2><i class="fas fa-users"></i> Registered Users</h2>
    <div id="usersContainer"></div>
  </div>

  <!-- PACKAGE BOOKINGS -->
  <div class="section-box">
    <h2><i class="fas fa-suitcase"></i> Package Bookings</h2>
    <div id="packageContainer"></div>
  </div>

  <!-- CAR BOOKINGS -->
  <div class="section-box">
    <h2><i class="fas fa-car"></i> Car Bookings</h2>
    <div id="carContainer"></div>
  </div>

  <!-- FEEDBACK -->
  <div class="section-box">
    <h2><i class="fas fa-comments"></i> Customer Feedback</h2>
    <div id="feedbackContainer"></div>
  </div>

</main>

<footer class="main-footer" role="contentinfo">
  <div class="footer-content">

    <!-- 1) Brand -->
    <p class="footer-brand">Sampada Tours & Travels</p>

    <!-- 2) Contact (primary action) -->
    <p class="footer-contact">
      <i class="fas fa-phone"></i> +91 9XXXXXXXXX &nbsp; | &nbsp;
      <i class="fas fa-envelope"></i> support@sampadatours.com
    </p>

    <!-- 3) Location (map link) -->
    <p class="address">
      <a 
        href="https://www.google.com/maps/search/?api=1&query=Kirana+Bazar+Road,+Mominpura,+Kalaburagi,+Karnataka"
        target="_blank" 
        rel="noopener noreferrer"
        class="map-link"
      >
        <i class="fas fa-map-marker-alt"></i>
        Kirana Bazar Road, Mominpura, Kalaburagi, Karnataka
      </a>
    </p>

    <!-- 4) Legal -->
    <p class="copyright">
      © <span id="year"></span> Sampada Tours & Travels · All rights reserved
    </p>

    <!-- 5) Developer Credit -->
    <p class="dev-credit">
      Developed by <strong>Navaneeth Gowda G</strong>
      &
      <strong>Abhishek Kumar Kolli</strong>
    </p>

  </div>
</footer>

<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const alertBox = document.getElementById("alertBox");

  AUTH.updateAuthUI();

  try {
    // USERS
    const usersData = await AUTH.apiRequest("/admin/users", { method: "GET" });
    renderUsers(usersData.users || []);
    document.getElementById("totalUsers").textContent = usersData.users.length;

    // PACKAGE BOOKINGS
    const packageData = await AUTH.apiRequest("/admin/bookings/package", { method: "GET" });
    renderPackageBookings(packageData.bookings || []);
    document.getElementById("totalPackages").textContent = packageData.bookings.length;

    // CAR BOOKINGS
    const carData = await AUTH.apiRequest("/admin/bookings/car", { method: "GET" });
    renderCarBookings(carData.bookings || []);
    document.getElementById("totalCars").textContent = carData.bookings.length;

    // FEEDBACK
    const feedbackData = await AUTH.apiRequest("/admin/feedback", { method: "GET" });
    renderFeedback(feedbackData.feedback || []);
    document.getElementById("totalFeedback").textContent = feedbackData.feedback.length;

  } catch (err) {
    console.error(err);
    alertBox.textContent = err.message || "Failed to load admin data.";
    alertBox.className = "alert-box error";
    alertBox.style.display = "block";
  }

  // =========================
  // RENDER FUNCTIONS
  // =========================

  function renderUsers(users) {
    const container = document.getElementById("usersContainer");
    if (users.length === 0) {
      container.innerHTML = `<div class="empty-box">No users found.</div>`;
      return;
    }

    let html = `
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Admin</th>
            <th>Joined</th>
          </tr>
        </thead>
        <tbody>
    `;

    users.forEach(u => {
      html += `
        <tr>
          <td>#${u.id}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.phone}</td>
          <td>${u.is_admin ? "Yes" : "No"}</td>
          <td>${formatDate(u.created_at)}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  function renderPackageBookings(bookings) {
    const container = document.getElementById("packageContainer");
    if (bookings.length === 0) {
      container.innerHTML = `<div class="empty-box">No package bookings.</div>`;
      return;
    }

    let html = `
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Package</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody>
    `;

    bookings.forEach(b => {
      html += `
        <tr>
          <td>#${b.id}</td>
          <td>${b.user_name || "Guest"}</td>
          <td>${b.user_phone || "-"}</td>
          <td>${b.package_name}</td>
          <td>${formatDate(b.travel_date)}</td>
          <td>₹${b.total_amount}</td>
          <td>
            <select id="pkg-status-${b.id}">
              <option value="pending" ${b.status === "pending" ? "selected" : ""}>Pending</option>
              <option value="confirmed" ${b.status === "confirmed" ? "selected" : ""}>Confirmed</option>
              <option value="completed" ${b.status === "completed" ? "selected" : ""}>Completed</option>
            </select>
          </td>
          <td>
            <button onclick="updatePackageStatus(${b.id})" class="btn-primary">Save</button>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  function renderCarBookings(bookings) {
    const container = document.getElementById("carContainer");
    if (bookings.length === 0) {
      container.innerHTML = `<div class="empty-box">No car bookings.</div>`;
      return;
    }

    let html = `
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Vehicle</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody>
    `;

    bookings.forEach(b => {
      html += `
        <tr>
          <td>#${b.id}</td>
          <td>${b.full_name}</td>
          <td>${b.phone}</td>
          <td>${b.vehicle_type}</td>
          <td>${formatDate(b.travel_date)}</td>
          <td>₹${b.total_amount}</td>
          <td>
            <select id="car-status-${b.id}">
              <option value="pending" ${b.status === "pending" ? "selected" : ""}>Pending</option>
              <option value="confirmed" ${b.status === "confirmed" ? "selected" : ""}>Confirmed</option>
              <option value="completed" ${b.status === "completed" ? "selected" : ""}>Completed</option>
            </select>
          </td>
          <td>
            <button onclick="updateCarStatus(${b.id})" class="btn-primary">Save</button>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  function renderFeedback(feedback) {
    const container = document.getElementById("feedbackContainer");
    if (feedback.length === 0) {
      container.innerHTML = `<div class="empty-box">No feedback yet.</div>`;
      return;
    }

    let html = `
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Service</th>
            <th>Message</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
    `;

    feedback.forEach(f => {
      html += `
        <tr>
          <td>#${f.id}</td>
          <td>${f.user_name}</td>
          <td>${f.email || "-"}</td>
          <td>${f.service_type}</td>
          <td>${f.message}</td>
          <td>${formatDate(f.created_at)}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString("en-IN");
  }

});
</script>

<!-- ================= GLOBAL FUNCTIONS (VERY IMPORTANT) ================= -->

<script>
async function updatePackageStatus(id) {
  const status = document.getElementById(`pkg-status-${id}`).value;

  try {
    await AUTH.apiRequest(`/admin/bookings/package/${id}/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });

    alert("✅ Package booking status updated successfully!");
    location.reload();

  } catch (err) {
    console.error("Package update failed:", err);
    alert("❌ Error: " + (err.message || "Failed to update package status"));
  }
}

async function updateCarStatus(id) {
  const status = document.getElementById(`car-status-${id}`).value;

  try {
    await AUTH.apiRequest(`/admin/bookings/car/${id}/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });

    alert("✅ Car booking status updated successfully!");
    location.reload();

  } catch (err) {
    console.error("Car update failed:", err);
    alert("❌ Error: " + (err.message || "Failed to update car status"));
  }
}
</script>


</body>
</html>
